<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì‹¤ì‹œê°„ ì±„íŒ…</title>
    <link rel="stylesheet" type="text/css" href="/stylesheets/main.css" />

    <!-- Socket.io -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
  </head>

  <body class="app-body">
    <nav class="navbar navbar-expand-lg app-nav shadow-sm sticky-top">
      <div class="container">
        <a class="navbar-brand" href="/">
          <span>ğŸŠ</span>
          ë‹¤ë§ˆë¼
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto align-items-lg-center gap-lg-2">
            <li class="nav-item">
              <a class="nav-link" href="/">í™ˆ</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/posts">ë‚´ ìƒí’ˆ ê´€ë¦¬</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/users">íšŒì› ëª©ë¡</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="/chat">ì‹¤ì‹œê°„ ì±„íŒ…</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container chat-shell py-4">
      <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
        <div>
          <h1 class="section-title mb-0">ì‹¤ì‹œê°„ ì±„íŒ…</h1>
          <p class="section-subtitle mb-0">
            ì±„íŒ…ë°© IDì™€ ì‚¬ìš©ì IDë¥¼ ì…ë ¥í•˜ë©´ ë°”ë¡œ ì†Œí†µí•  ìˆ˜ ìˆì–´ìš”.
          </p>
        </div>
        <div class="chip">
          <span class="connection-status disconnected" id="connection-status"></span>
          <span id="connection-text">ì—°ê²° ì¤‘...</span>
        </div>
      </div>

      <!-- ì±„íŒ…ë°© ì„ íƒ ì˜ì—­ -->
      <div class="chat-room-selector mb-4">
        <h5 class="mb-3">ì±„íŒ…ë°© ì„¤ì •</h5>
        <div class="row g-3">
          <div class="col-md-4">
            <label for="chat-room-id" class="form-label">ì±„íŒ…ë°© ID</label>
            <input
              type="text"
              class="form-control"
              id="chat-room-id"
              placeholder="ì±„íŒ…ë°© UUID ì…ë ¥"
            />
          </div>
          <div class="col-md-4">
            <label for="user-id" class="form-label">ì‚¬ìš©ì ID</label>
            <input
              type="text"
              class="form-control"
              id="user-id"
              placeholder="ì‚¬ìš©ì UUID ì…ë ¥"
            />
          </div>
          <div class="col-md-4 d-flex align-items-end">
            <button class="btn btn-primary w-100" id="join-room-btn">
              ì±„íŒ…ë°© ì…ì¥
            </button>
          </div>
        </div>
        <div class="mt-3">
          <small class="text-muted">
            ğŸ’¡ íŒ: ë¨¼ì € Postë¥¼ ìƒì„±í•œ í›„, í•´ë‹¹ Postì˜ IDë¡œ ì±„íŒ…ë°©ì„ ìƒì„±í•˜ì„¸ìš”.
            <br />
            API: POST /api/chat/rooms (body: { chatRoom: { postId } })
          </small>
        </div>
      </div>

      <!-- ì±„íŒ… ì»¨í…Œì´ë„ˆ -->
      <div
        class="chat-container shadow-lg"
        id="chat-container"
        style="display: none"
      >
        <div class="chat-header">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h5 class="mb-0" id="chat-room-title">ì±„íŒ…ë°©</h5>
              <small id="chat-room-id-display"></small>
            </div>
            <button class="btn btn-light btn-sm" id="leave-room-btn">
              ë‚˜ê°€ê¸°
            </button>
          </div>
        </div>

        <div class="chat-messages" id="chat-messages">
          <!-- ë©”ì‹œì§€ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>

        <div class="chat-input-area">
          <div class="input-group">
            <input
              type="text"
              class="form-control"
              id="message-input"
              placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
              disabled
            />
            <button
              class="btn btn-primary"
              type="button"
              id="send-message-btn"
              disabled
            >
              ì „ì†¡
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ì „ì—­ ë³€ìˆ˜
      let socket = null;
      let currentChatRoomId = null;
      let currentUserId = null;
      let displayedMessageIds = new Set(); // í‘œì‹œëœ ë©”ì‹œì§€ ID ì¶”ì 
      let isLoadingHistory = false; // ë©”ì‹œì§€ íˆìŠ¤í† ë¦¬ ë¡œë”© ì¤‘ í”Œë˜ê·¸

      // DOM ìš”ì†Œ
      const chatRoomIdInput = document.getElementById("chat-room-id");
      const userIdInput = document.getElementById("user-id");
      const joinRoomBtn = document.getElementById("join-room-btn");
      const leaveRoomBtn = document.getElementById("leave-room-btn");
      const chatContainer = document.getElementById("chat-container");
      const chatMessages = document.getElementById("chat-messages");
      const messageInput = document.getElementById("message-input");
      const sendMessageBtn = document.getElementById("send-message-btn");
      const connectionStatus = document.getElementById("connection-status");
      const connectionText = document.getElementById("connection-text");
      const chatRoomTitle = document.getElementById("chat-room-title");
      const chatRoomIdDisplay = document.getElementById("chat-room-id-display");

      // ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
      function updateConnectionStatus(connected) {
        if (connected) {
          connectionStatus.classList.remove("disconnected");
          connectionStatus.classList.add("connected");
          connectionText.textContent = "ì—°ê²°ë¨";
        } else {
          connectionStatus.classList.remove("connected");
          connectionStatus.classList.add("disconnected");
          connectionText.textContent = "ì—°ê²° ëŠê¹€";
        }
      }

      // ì±„íŒ…ë°© ì…ì¥ í•¨ìˆ˜
      function joinChatRoom(chatRoomId, userId) {
        if (!chatRoomId || !userId) {
          alert("ì±„íŒ…ë°© IDì™€ ì‚¬ìš©ì IDë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        if (!socket || !socket.connected) {
          alert("ì„œë²„ì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
          return;
        }

        // ê¸°ì¡´ ì±„íŒ…ë°©ì´ ìˆìœ¼ë©´ ë‚˜ê°€ê¸°
        if (currentChatRoomId && currentChatRoomId !== chatRoomId) {
          socket.emit("leave_chat_room", {
            chatRoomId: currentChatRoomId,
            userId: currentUserId,
          });
        }

        // ì±„íŒ…ë°© ì…ì¥
        socket.emit("join_chat_room", {
          chatRoomId: chatRoomId,
          userId: userId,
        });

        currentChatRoomId = chatRoomId;
        currentUserId = userId;

        // í‘œì‹œëœ ë©”ì‹œì§€ ID ì´ˆê¸°í™”
        displayedMessageIds.clear();

        // UI ì—…ë°ì´íŠ¸
        chatContainer.style.display = "flex";
        chatRoomTitle.textContent = "ì±„íŒ…ë°©";
        chatRoomIdDisplay.textContent = `ID: ${chatRoomId}`;
        messageInput.disabled = false;
        sendMessageBtn.disabled = false;
        chatRoomIdInput.disabled = true;
        userIdInput.disabled = true;
        joinRoomBtn.disabled = true;

        // ë©”ì‹œì§€ íˆìŠ¤í† ë¦¬ ë¡œë“œ
        loadMessageHistory(chatRoomId);
      }

      // ì±„íŒ…ë°© ì…ì¥ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
      joinRoomBtn.addEventListener("click", () => {
        const chatRoomId = chatRoomIdInput.value.trim();
        const userId = userIdInput.value.trim();
        joinChatRoom(chatRoomId, userId);
      });

      // ì±„íŒ…ë°© ë‚˜ê°€ê¸°
      leaveRoomBtn.addEventListener("click", () => {
        if (socket && currentChatRoomId && currentUserId) {
          socket.emit("leave_chat_room", {
            chatRoomId: currentChatRoomId,
            userId: currentUserId,
          });
        }

        // UI ì´ˆê¸°í™”
        chatContainer.style.display = "none";
        chatMessages.innerHTML = "";
        messageInput.value = "";
        messageInput.disabled = true;
        sendMessageBtn.disabled = true;
        chatRoomIdInput.disabled = false;
        userIdInput.disabled = false;
        joinRoomBtn.disabled = false;

        // ìƒíƒœ ì´ˆê¸°í™”
        currentChatRoomId = null;
        currentUserId = null;
        displayedMessageIds.clear();
        isLoadingHistory = false;
      });

      // ë©”ì‹œì§€ ì „ì†¡
      function sendMessage() {
        const content = messageInput.value.trim();
        if (!content || !socket || !currentChatRoomId || !currentUserId) {
          return;
        }

        // ì…ë ¥ í•„ë“œ ë¹„ìš°ê¸° (ì „ì†¡ ì „ì— ë¹„ì›Œì„œ ì‚¬ìš©ì ê²½í—˜ ê°œì„ )
        messageInput.value = "";

        // Optimistic update: ì¦‰ì‹œ ì„ì‹œ ë©”ì‹œì§€ í‘œì‹œ
        const tempMessageId = `temp-${Date.now()}-${Math.random()}`;
        const tempMessage = {
          id: tempMessageId,
          chatRoomId: currentChatRoomId,
          senderId: currentUserId,
          content: content,
          messageType: "text",
          sender: {
            id: currentUserId,
            nickname: "ë‚˜", // ì„ì‹œë¡œ "ë‚˜"ë¡œ í‘œì‹œ, ì„œë²„ ì‘ë‹µ ì‹œ ì‹¤ì œ ë‹‰ë„¤ì„ìœ¼ë¡œ êµì²´ë¨
          },
          createdAt: new Date().toISOString(),
          isTemp: true, // ì„ì‹œ ë©”ì‹œì§€ í”Œë˜ê·¸
        };

        // ì„ì‹œ ë©”ì‹œì§€ í‘œì‹œ (ì¤‘ë³µ ì²´í¬ ìŠ¤í‚µ)
        displayMessage(tempMessage, true);

        // ì„œë²„ë¡œ ë©”ì‹œì§€ ì „ì†¡
        socket.emit("send_message", {
          chatRoomId: currentChatRoomId,
          senderId: currentUserId,
          content: content,
          messageType: "text",
        });
      }

      sendMessageBtn.addEventListener("click", sendMessage);
      messageInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          sendMessage();
        }
      });

      // ë©”ì‹œì§€ í‘œì‹œ
      function displayMessage(message, skipDuplicateCheck = false) {
        // ì¤‘ë³µ ë©”ì‹œì§€ ì²´í¬ (íˆìŠ¤í† ë¦¬ ë¡œë”© ì¤‘ì´ ì•„ë‹ ë•Œë§Œ)
        if (!skipDuplicateCheck && message.id && displayedMessageIds.has(message.id)) {
          console.log("ì¤‘ë³µ ë©”ì‹œì§€ ë¬´ì‹œ:", message.id);
          return;
        }

        // ì„ì‹œ ë©”ì‹œì§€ì¸ ê²½ìš°, ì‹¤ì œ ë©”ì‹œì§€ë¡œ êµì²´
        if (message.isTemp && message.id && message.id.startsWith("temp-")) {
          // ì„ì‹œ ë©”ì‹œì§€ ì°¾ê¸° (ë‚´ìš©ê³¼ ë°œì‹ ìë¡œ ë§¤ì¹­)
          const tempMessageDiv = chatMessages.querySelector(
            `[data-message-id="${message.id}"]`
          );
          if (tempMessageDiv) {
            // ì„ì‹œ ë©”ì‹œì§€ ì œê±°
            tempMessageDiv.remove();
            // ì„ì‹œ ë©”ì‹œì§€ ID ì œê±°
            displayedMessageIds.delete(message.id);
          }
        }

        // ë©”ì‹œì§€ ID ì €ì¥
        if (message.id) {
          displayedMessageIds.add(message.id);
        }

        const messageDiv = document.createElement("div");
        messageDiv.className = `message-item ${
          message.senderId === currentUserId ? "own-message" : "other-message"
        }`;
        
        // ë©”ì‹œì§€ IDë¥¼ data ì†ì„±ìœ¼ë¡œ ì €ì¥ (ë‚˜ì¤‘ì— ì°¸ì¡° ê°€ëŠ¥)
        if (message.id) {
          messageDiv.setAttribute("data-message-id", message.id);
        }

        const senderName = message.sender?.nickname || "ì•Œ ìˆ˜ ì—†ìŒ";
        const messageTime = new Date(message.createdAt).toLocaleTimeString(
          "ko-KR",
          {
            hour: "2-digit",
            minute: "2-digit",
          }
        );

        messageDiv.innerHTML = `
          <div class="message-sender">${senderName}</div>
          <div class="message-content">${escapeHtml(message.content)}</div>
          <div class="message-time">${messageTime}</div>
        `;

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // ì‹œìŠ¤í…œ ë©”ì‹œì§€ í‘œì‹œ
      function showSystemMessage(text) {
        const systemDiv = document.createElement("div");
        systemDiv.className = "system-message";
        systemDiv.textContent = text;
        chatMessages.appendChild(systemDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // ë©”ì‹œì§€ íˆìŠ¤í† ë¦¬ ë¡œë“œ
      async function loadMessageHistory(chatRoomId) {
        if (isLoadingHistory) {
          console.log("ì´ë¯¸ ë©”ì‹œì§€ íˆìŠ¤í† ë¦¬ë¥¼ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤.");
          return;
        }

        isLoadingHistory = true;
        try {
          const response = await fetch(
            `http://localhost:3000/api/chat/rooms/${chatRoomId}/messages?limit=50&offset=0`
          );
          if (response.ok) {
            const messages = await response.json();
            chatMessages.innerHTML = "";
            displayedMessageIds.clear(); // íˆìŠ¤í† ë¦¬ ë¡œë“œ ì‹œ ID ì„¸íŠ¸ ì´ˆê¸°í™”
            
            // ë©”ì‹œì§€ë¥¼ ì‹œê°„ìˆœìœ¼ë¡œ ì •ë ¬í•˜ì—¬ í‘œì‹œ
            messages.forEach((message) => {
              displayMessage(message, true); // íˆìŠ¤í† ë¦¬ ë¡œë”© ì¤‘ì´ë¯€ë¡œ ì¤‘ë³µ ì²´í¬ ìŠ¤í‚µ
            });
          }
        } catch (error) {
          console.error("ë©”ì‹œì§€ íˆìŠ¤í† ë¦¬ ë¡œë“œ ì‹¤íŒ¨:", error);
        } finally {
          isLoadingHistory = false;
        }
      }

      // HTML ì´ìŠ¤ì¼€ì´í”„
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // URL íŒŒë¼ë¯¸í„°ì—ì„œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      const urlParams = new URLSearchParams(window.location.search);
      const urlPostId = urlParams.get("postId");
      const urlUserId = urlParams.get("userId");
      const urlChatRoomId = urlParams.get("chatRoomId");

      // ìë™ ì…ì¥ í”Œë˜ê·¸
      let shouldAutoJoin = false;
      let autoJoinChatRoomId = null;
      let autoJoinUserId = null;

      // URL íŒŒë¼ë¯¸í„°ê°€ ìˆìœ¼ë©´ ìë™ ì…ì¥ ì¤€ë¹„
      if (urlPostId && urlUserId) {
        chatRoomIdInput.value = urlChatRoomId || "";
        userIdInput.value = urlUserId;
        shouldAutoJoin = true;
        autoJoinUserId = urlUserId;

        // Post IDë¡œ ì±„íŒ…ë°© ì¡°íšŒ/ìƒì„±
        if (urlChatRoomId) {
          // ì±„íŒ…ë°© IDê°€ ìˆìœ¼ë©´ ë°”ë¡œ ì‚¬ìš©
          autoJoinChatRoomId = urlChatRoomId;
        } else {
          // Post IDë§Œ ìˆìœ¼ë©´ ì±„íŒ…ë°© ì¡°íšŒ/ìƒì„±
          fetch(`/api/chat/rooms/post/${urlPostId}`)
            .then((response) => response.json())
            .then((chatRoom) => {
              chatRoomIdInput.value = chatRoom.id;
              autoJoinChatRoomId = chatRoom.id;
              // Socket.io ì—°ê²°ì´ ì™„ë£Œë˜ì—ˆìœ¼ë©´ ë°”ë¡œ ì…ì¥
              if (socket && socket.connected) {
                joinChatRoom(chatRoom.id, urlUserId);
              }
            })
            .catch((error) => {
              console.error("ì±„íŒ…ë°© ì¡°íšŒ ì‹¤íŒ¨:", error);
              showSystemMessage("ì±„íŒ…ë°©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
        }
      }

      // Socket.io ì—°ê²°
      function connectSocket() {
        // ê¸°ì¡´ ì†Œì¼“ì´ ìˆìœ¼ë©´ ì—°ê²° í•´ì œ
        if (socket) {
          socket.removeAllListeners();
          socket.disconnect();
        }

        socket = io("http://localhost:3000", {
          transports: ["websocket", "polling"],
        });

        socket.on("connect", () => {
          console.log("âœ“ ì„œë²„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤:", socket.id);
          updateConnectionStatus(true);

          // ìë™ ì…ì¥ì´ ì„¤ì •ë˜ì–´ ìˆìœ¼ë©´ ì…ì¥
          if (shouldAutoJoin && autoJoinChatRoomId && autoJoinUserId) {
            joinChatRoom(autoJoinChatRoomId, autoJoinUserId);
          }
        });

        socket.on("disconnect", () => {
          console.log("âœ— ì„œë²„ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤");
          updateConnectionStatus(false);
        });

        socket.on("connect_error", (error) => {
          console.error("âœ— ì—°ê²° ì˜¤ë¥˜:", error);
          updateConnectionStatus(false);
          showSystemMessage(
            "ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”."
          );
        });

        // ë©”ì‹œì§€ ìˆ˜ì‹  (ì¤‘ë³µ ë°©ì§€ ë¡œì§ í¬í•¨)
        socket.on("receive_message", (message) => {
          console.log("ë©”ì‹œì§€ ìˆ˜ì‹ :", message);
          // í˜„ì¬ ì±„íŒ…ë°©ì˜ ë©”ì‹œì§€ë§Œ í‘œì‹œ
          if (message.chatRoomId === currentChatRoomId) {
            // ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ì¸ ê²½ìš°, ì„ì‹œ ë©”ì‹œì§€ë¥¼ ì‹¤ì œ ë©”ì‹œì§€ë¡œ êµì²´
            if (message.senderId === currentUserId) {
              // ì„ì‹œ ë©”ì‹œì§€ ì°¾ì•„ì„œ ì œê±°
              const tempMessages = chatMessages.querySelectorAll(
                '[data-message-id^="temp-"]'
              );
              tempMessages.forEach((tempMsg) => {
                const tempContent = tempMsg.querySelector(".message-content")?.textContent;
                if (tempContent === message.content) {
                  tempMsg.remove();
                  const tempId = tempMsg.getAttribute("data-message-id");
                  if (tempId) {
                    displayedMessageIds.delete(tempId);
                  }
                }
              });
            }
            displayMessage(message, false); // ì¤‘ë³µ ì²´í¬ ìˆ˜í–‰
          }
        });

        // ì‚¬ìš©ì ì…ì¥ ì•Œë¦¼
        socket.on("user_joined", (data) => {
          console.log("ì‚¬ìš©ì ì…ì¥:", data);
          // í˜„ì¬ ì±„íŒ…ë°©ì˜ ì•Œë¦¼ë§Œ í‘œì‹œ
          if (data.chatRoomId === currentChatRoomId) {
            showSystemMessage(`ì‚¬ìš©ìê°€ ì±„íŒ…ë°©ì— ì…ì¥í–ˆìŠµë‹ˆë‹¤.`);
          }
        });

        // ì‚¬ìš©ì í‡´ì¥ ì•Œë¦¼
        socket.on("user_left", (data) => {
          console.log("ì‚¬ìš©ì í‡´ì¥:", data);
          // í˜„ì¬ ì±„íŒ…ë°©ì˜ ì•Œë¦¼ë§Œ í‘œì‹œ
          if (data.chatRoomId === currentChatRoomId) {
            showSystemMessage(`ì‚¬ìš©ìê°€ ì±„íŒ…ë°©ì„ ë‚˜ê°”ìŠµë‹ˆë‹¤.`);
          }
        });

        // ë©”ì‹œì§€ ì½ìŒ ì²˜ë¦¬ ì•Œë¦¼
        socket.on("message_read", (data) => {
          console.log("ë©”ì‹œì§€ ì½ìŒ:", data);
        });

        // ì—ëŸ¬ ì²˜ë¦¬
        socket.on("error", (error) => {
          console.error("ì—ëŸ¬:", error);
          showSystemMessage(
            `ì˜¤ë¥˜: ${error.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."}`
          );
        });
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ Socket.io ì—°ê²°
      connectSocket();

      // í˜ì´ì§€ ì¢…ë£Œ ì‹œ ì—°ê²° í•´ì œ
      window.addEventListener("beforeunload", () => {
        if (socket && currentChatRoomId && currentUserId) {
          socket.emit("leave_chat_room", {
            chatRoomId: currentChatRoomId,
            userId: currentUserId,
          });
          socket.disconnect();
        }
      });
    </script>
  </body>
</html>
