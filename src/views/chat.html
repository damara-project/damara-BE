<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>실시간 채팅</title>
    <link rel="icon" type="image/png" href="/uploads/images/TE.png" />
    <link rel="stylesheet" type="text/css" href="/stylesheets/main.css" />

    <!-- Socket.io -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
  </head>

  <body class="app-body">
    <nav class="navbar navbar-expand-lg app-nav mb-4">
      <div class="container">
        <a class="navbar-brand" href="/">
          <span class="brand-text">Damara</span>
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto align-items-center gap-3">
            <li class="nav-item">
              <a class="nav-link" href="/">홈</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/posts">내 상품</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/users">회원 목록</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="/chat">채팅</a>
            </li>
            <li class="nav-item">
              <button
                class="btn btn-link nav-link p-0"
                id="login-modal-btn"
                style="text-decoration: none"
              >
                로그인
              </button>
            </li>
            <li class="nav-item">
              <button class="btn btn-primary btn-sm" id="register-modal-btn">
                회원가입
              </button>
            </li>
            <li class="nav-item">
              <span
                id="current-user-display"
                class="d-none d-flex align-items-center gap-2"
              >
                <span
                  id="user-nickname-display"
                  class="fw-semibold"
                  style="color: var(--text-strong)"
                ></span>
                <span
                  id="trust-score-display"
                  class="badge bg-success d-none"
                  style="font-size: 0.75rem"
                ></span>
                <button
                  class="btn btn-sm btn-outline-secondary"
                  id="logout-btn"
                  style="border-radius: var(--radius-sm)"
                >
                  로그아웃
                </button>
              </span>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container chat-shell py-4">
      <div
        class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2"
      >
        <div>
          <h1 class="section-title mb-0">실시간 채팅</h1>
          <p class="section-subtitle mb-0">
            채팅방 ID와 사용자 ID를 입력하면 바로 소통할 수 있어요.
          </p>
        </div>
        <div class="chip">
          <span
            class="connection-status disconnected"
            id="connection-status"
          ></span>
          <span id="connection-text">연결 중...</span>
        </div>
      </div>

      <!-- 채팅방 목록 (로그인한 사용자만 표시) -->
      <div id="chat-rooms-section" class="mb-4" style="display: none">
        <h3 class="mb-3">내 채팅방 목록</h3>
        <div id="chat-rooms-list" class="row g-3">
          <!-- 채팅방 목록이 여기에 표시됨 -->
        </div>
      </div>

      <!-- 채팅 컨테이너 -->
      <div class="chat-panel">
        <div
          class="chat-container shadow-lg"
          id="chat-container"
          style="display: none"
        >
          <div class="chat-header">
            <div>
              <h5 class="mb-1" id="chat-room-title">채팅방</h5>
              <small id="chat-room-id-display"></small>
            </div>
            <!-- 입장 전: ID 입력 필드와 입장 버튼 -->
            <div id="chat-room-join-controls" class="d-flex gap-2">
              <input
                class="form-control form-control-sm"
                id="chat-room-id"
                placeholder="채팅방 ID"
              />
              <input
                class="form-control form-control-sm"
                id="user-id"
                placeholder="사용자 ID"
              />
              <button class="btn btn-primary btn-sm" id="join-room-btn">
                입장
              </button>
            </div>
            <!-- 입장 후: 나가기 버튼만 -->
            <div id="chat-room-leave-controls" class="d-none">
              <button class="btn btn-outline-danger btn-sm" id="leave-room-btn">
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 16 16"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  style="margin-right: 4px; vertical-align: middle"
                >
                  <path d="M12 4l-8 8M4 4l8 8" />
                </svg>
                나가기
              </button>
            </div>
          </div>

          <div class="chat-messages" id="chat-messages">
            <!-- 메시지들이 여기에 표시됩니다 -->
          </div>

          <div class="chat-input-area">
            <div class="input-group">
              <input
                type="text"
                class="form-control"
                id="message-input"
                placeholder="메시지를 입력하세요..."
                disabled
              />
              <button
                class="btn btn-primary"
                type="button"
                id="send-message-btn"
                disabled
              >
                전송
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // 전역 변수
      let socket = null;
      let currentChatRoomId = null;
      let currentUserId = null;
      let displayedMessageIds = new Set(); // 표시된 메시지 ID 추적
      let isLoadingHistory = false; // 메시지 히스토리 로딩 중 플래그

      // DOM 요소
      const chatRoomIdInput = document.getElementById("chat-room-id");
      const userIdInput = document.getElementById("user-id");
      const joinRoomBtn = document.getElementById("join-room-btn");
      const leaveRoomBtn = document.getElementById("leave-room-btn");
      const chatContainer = document.getElementById("chat-container");
      const chatMessages = document.getElementById("chat-messages");
      const messageInput = document.getElementById("message-input");
      const sendMessageBtn = document.getElementById("send-message-btn");
      const connectionStatus = document.getElementById("connection-status");
      const connectionText = document.getElementById("connection-text");
      const chatRoomTitle = document.getElementById("chat-room-title");
      const chatRoomIdDisplay = document.getElementById("chat-room-id-display");

      // 연결 상태 업데이트
      function updateConnectionStatus(connected) {
        if (connected) {
          connectionStatus.classList.remove("disconnected");
          connectionStatus.classList.add("connected");
          connectionText.textContent = "연결됨";
        } else {
          connectionStatus.classList.remove("connected");
          connectionStatus.classList.add("disconnected");
          connectionText.textContent = "연결 끊김";
        }
      }

      // 채팅방 입장 함수
      function joinChatRoom(chatRoomId, userId) {
        if (!chatRoomId || !userId) {
          alert("채팅방 ID와 사용자 ID를 모두 입력해주세요.");
          return;
        }

        if (!socket || !socket.connected) {
          alert("서버에 연결되지 않았습니다. 잠시 후 다시 시도해주세요.");
          return;
        }

        // 기존 채팅방이 있으면 나가기
        if (currentChatRoomId && currentChatRoomId !== chatRoomId) {
          socket.emit("leave_chat_room", {
            chatRoomId: currentChatRoomId,
            userId: currentUserId,
          });
        }

        // 채팅방 입장
        socket.emit("join_chat_room", {
          chatRoomId: chatRoomId,
          userId: userId,
        });

        currentChatRoomId = chatRoomId;
        currentUserId = userId;

        // 표시된 메시지 ID 초기화
        displayedMessageIds.clear();

        // UI 업데이트
        chatContainer.style.display = "flex";
        chatRoomTitle.textContent = "채팅방";
        chatRoomIdDisplay.textContent = `ID: ${chatRoomId}`;
        messageInput.disabled = false;
        sendMessageBtn.disabled = false;

        // 입장 전 컨트롤 숨기기, 나가기 버튼만 보이기
        document
          .getElementById("chat-room-join-controls")
          .classList.add("d-none");
        document
          .getElementById("chat-room-leave-controls")
          .classList.remove("d-none");

        // 메시지 히스토리 로드
        loadMessageHistory(chatRoomId);
      }

      // 채팅방 입장 버튼 클릭 이벤트
      joinRoomBtn.addEventListener("click", () => {
        const chatRoomId = chatRoomIdInput.value.trim();
        const userId = userIdInput.value.trim();
        joinChatRoom(chatRoomId, userId);
      });

      // 채팅방 나가기
      leaveRoomBtn.addEventListener("click", () => {
        if (socket && currentChatRoomId && currentUserId) {
          socket.emit("leave_chat_room", {
            chatRoomId: currentChatRoomId,
            userId: currentUserId,
          });
        }

        // UI 초기화
        chatContainer.style.display = "none";
        chatMessages.innerHTML = "";
        messageInput.value = "";
        messageInput.disabled = true;
        sendMessageBtn.disabled = true;

        // 나가기 버튼 숨기고, 입장 컨트롤 다시 보이기
        document
          .getElementById("chat-room-join-controls")
          .classList.remove("d-none");
        document
          .getElementById("chat-room-leave-controls")
          .classList.add("d-none");
        chatRoomIdInput.value = "";
        userIdInput.value = "";

        // 상태 초기화
        currentChatRoomId = null;
        currentUserId = null;
        displayedMessageIds.clear();
        isLoadingHistory = false;
      });

      // 메시지 전송
      function sendMessage() {
        const content = messageInput.value.trim();
        if (!content || !socket || !currentChatRoomId || !currentUserId) {
          return;
        }

        // 입력 필드 비우기 (전송 전에 비워서 사용자 경험 개선)
        messageInput.value = "";

        // Optimistic update: 즉시 임시 메시지 표시
        const tempMessageId = `temp-${Date.now()}-${Math.random()}`;
        const tempMessage = {
          id: tempMessageId,
          chatRoomId: currentChatRoomId,
          senderId: currentUserId,
          content: content,
          messageType: "text",
          sender: {
            id: currentUserId,
            nickname: "나", // 임시로 "나"로 표시, 서버 응답 시 실제 닉네임으로 교체됨
          },
          createdAt: new Date().toISOString(),
          isTemp: true, // 임시 메시지 플래그
        };

        // 임시 메시지 표시 (중복 체크 스킵)
        displayMessage(tempMessage, true);

        // 서버로 메시지 전송
        socket.emit("send_message", {
          chatRoomId: currentChatRoomId,
          senderId: currentUserId,
          content: content,
          messageType: "text",
        });
      }

      sendMessageBtn.addEventListener("click", sendMessage);
      messageInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          sendMessage();
        }
      });

      // 메시지 표시
      function displayMessage(message, skipDuplicateCheck = false) {
        // 중복 메시지 체크 (히스토리 로딩 중이 아닐 때만)
        if (
          !skipDuplicateCheck &&
          message.id &&
          displayedMessageIds.has(message.id)
        ) {
          console.log("중복 메시지 무시:", message.id);
          return;
        }

        // 임시 메시지인 경우, 실제 메시지로 교체
        if (message.isTemp && message.id && message.id.startsWith("temp-")) {
          // 임시 메시지 찾기 (내용과 발신자로 매칭)
          const tempMessageDiv = chatMessages.querySelector(
            `[data-message-id="${message.id}"]`
          );
          if (tempMessageDiv) {
            // 임시 메시지 제거
            tempMessageDiv.remove();
            // 임시 메시지 ID 제거
            displayedMessageIds.delete(message.id);
          }
        }

        // 메시지 ID 저장
        if (message.id) {
          displayedMessageIds.add(message.id);
        }

        const messageDiv = document.createElement("div");
        messageDiv.className = `message-item ${
          message.senderId === currentUserId ? "own-message" : "other-message"
        }`;

        // 메시지 ID를 data 속성으로 저장 (나중에 참조 가능)
        if (message.id) {
          messageDiv.setAttribute("data-message-id", message.id);
        }

        const senderName = message.sender?.nickname || "알 수 없음";
        const messageTime = new Date(message.createdAt).toLocaleTimeString(
          "ko-KR",
          {
            hour: "2-digit",
            minute: "2-digit",
          }
        );

        messageDiv.innerHTML = `
          <div class="message-sender">${senderName}</div>
          <div class="message-content">${escapeHtml(message.content)}</div>
          <div class="message-time">${messageTime}</div>
        `;

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // 시스템 메시지 표시
      function showSystemMessage(text) {
        const systemDiv = document.createElement("div");
        systemDiv.className = "system-message";
        systemDiv.textContent = text;
        chatMessages.appendChild(systemDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // 메시지 히스토리 로드
      async function loadMessageHistory(chatRoomId) {
        if (isLoadingHistory) {
          console.log("이미 메시지 히스토리를 로딩 중입니다.");
          return;
        }

        isLoadingHistory = true;
        try {
          const response = await fetch(
            `http://localhost:3000/api/chat/rooms/${chatRoomId}/messages?limit=50&offset=0`
          );
          if (response.ok) {
            const messages = await response.json();
            chatMessages.innerHTML = "";
            displayedMessageIds.clear(); // 히스토리 로드 시 ID 세트 초기화

            // 메시지를 시간순으로 정렬하여 표시
            messages.forEach((message) => {
              displayMessage(message, true); // 히스토리 로딩 중이므로 중복 체크 스킵
            });
          }
        } catch (error) {
          console.error("메시지 히스토리 로드 실패:", error);
        } finally {
          isLoadingHistory = false;
        }
      }

      // HTML 이스케이프
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // URL 파라미터에서 정보 가져오기
      const urlParams = new URLSearchParams(window.location.search);
      const urlPostId = urlParams.get("postId");
      const urlUserId = urlParams.get("userId");
      const urlChatRoomId = urlParams.get("chatRoomId");

      // 자동 입장 플래그
      let shouldAutoJoin = false;
      let autoJoinChatRoomId = null;
      let autoJoinUserId = null;

      // URL 파라미터가 있으면 자동 입장 준비
      if (urlPostId && urlUserId) {
        chatRoomIdInput.value = urlChatRoomId || "";
        userIdInput.value = urlUserId;
        shouldAutoJoin = true;
        autoJoinUserId = urlUserId;

        // Post ID로 채팅방 조회/생성
        if (urlChatRoomId) {
          // 채팅방 ID가 있으면 바로 사용
          autoJoinChatRoomId = urlChatRoomId;
        } else {
          // Post ID만 있으면 채팅방 조회/생성
          fetch(`/api/chat/rooms/post/${urlPostId}`)
            .then((response) => response.json())
            .then((chatRoom) => {
              chatRoomIdInput.value = chatRoom.id;
              autoJoinChatRoomId = chatRoom.id;
              // Socket.io 연결이 완료되었으면 바로 입장
              if (socket && socket.connected) {
                joinChatRoom(chatRoom.id, urlUserId);
              }
            })
            .catch((error) => {
              console.error("채팅방 조회 실패:", error);
              showSystemMessage("채팅방을 불러오는 중 오류가 발생했습니다.");
            });
        }
      }

      // Socket.io 연결
      function connectSocket() {
        // 기존 소켓이 있으면 연결 해제
        if (socket) {
          socket.removeAllListeners();
          socket.disconnect();
        }

        socket = io("http://localhost:3000", {
          transports: ["websocket", "polling"],
        });

        socket.on("connect", () => {
          console.log("✓ 서버에 연결되었습니다:", socket.id);
          updateConnectionStatus(true);

          // 자동 입장이 설정되어 있으면 입장
          if (shouldAutoJoin && autoJoinChatRoomId && autoJoinUserId) {
            joinChatRoom(autoJoinChatRoomId, autoJoinUserId);
          }
        });

        socket.on("disconnect", () => {
          console.log("✗ 서버 연결이 끊어졌습니다");
          updateConnectionStatus(false);
        });

        socket.on("connect_error", (error) => {
          console.error("✗ 연결 오류:", error);
          updateConnectionStatus(false);
          showSystemMessage(
            "서버 연결에 실패했습니다. 서버가 실행 중인지 확인하세요."
          );
        });

        // 메시지 수신 (중복 방지 로직 포함)
        socket.on("receive_message", (message) => {
          console.log("메시지 수신:", message);
          // 현재 채팅방의 메시지만 표시
          if (message.chatRoomId === currentChatRoomId) {
            // 내가 보낸 메시지인 경우, 임시 메시지를 실제 메시지로 교체
            if (message.senderId === currentUserId) {
              // 임시 메시지 찾아서 제거
              const tempMessages = chatMessages.querySelectorAll(
                '[data-message-id^="temp-"]'
              );
              tempMessages.forEach((tempMsg) => {
                const tempContent =
                  tempMsg.querySelector(".message-content")?.textContent;
                if (tempContent === message.content) {
                  tempMsg.remove();
                  const tempId = tempMsg.getAttribute("data-message-id");
                  if (tempId) {
                    displayedMessageIds.delete(tempId);
                  }
                }
              });
            }
            displayMessage(message, false); // 중복 체크 수행
          }
        });

        // 사용자 입장 알림
        socket.on("user_joined", (data) => {
          console.log("사용자 입장:", data);
          // 현재 채팅방의 알림만 표시
          if (data.chatRoomId === currentChatRoomId) {
            showSystemMessage(`사용자가 채팅방에 입장했습니다.`);
          }
        });

        // 사용자 퇴장 알림
        socket.on("user_left", (data) => {
          console.log("사용자 퇴장:", data);
          // 현재 채팅방의 알림만 표시
          if (data.chatRoomId === currentChatRoomId) {
            showSystemMessage(`사용자가 채팅방을 나갔습니다.`);
          }
        });

        // 메시지 읽음 처리 알림
        socket.on("message_read", (data) => {
          console.log("메시지 읽음:", data);
        });

        // 에러 처리
        socket.on("error", (error) => {
          console.error("에러:", error);
          showSystemMessage(
            `오류: ${error.message || "알 수 없는 오류가 발생했습니다."}`
          );
        });
      }

      // 페이지 로드 시 Socket.io 연결
      connectSocket();

      // 페이지 종료 시 연결 해제
      window.addEventListener("beforeunload", () => {
        if (socket && currentChatRoomId && currentUserId) {
          socket.emit("leave_chat_room", {
            chatRoomId: currentChatRoomId,
            userId: currentUserId,
          });
          socket.disconnect();
        }
      });

      // ============================================================================
      // 채팅방 목록 로드
      // ============================================================================
      async function loadChatRooms(userId) {
        try {
          const response = await fetch(`/api/chat/rooms/user/${userId}`);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          const chatRooms = data.chatRooms || [];

          const roomsList = document.getElementById("chat-rooms-list");
          const roomsSection = document.getElementById("chat-rooms-section");

          if (chatRooms.length === 0) {
            roomsList.innerHTML =
              '<div class="col-12"><p class="text-muted text-center">참여한 채팅방이 없습니다.</p></div>';
            if (roomsSection) roomsSection.style.display = "block";
            return;
          }

          const html = chatRooms
            .map(
              (room) => `
            <div class="col-md-6 col-lg-4">
              <div class="card h-100">
                <div class="card-body">
                  <h6 class="card-title">${room.post?.title || "제목 없음"}</h6>
                  <p class="card-text small text-muted">
                    ${
                      room.lastMessage
                        ? room.lastMessage.content
                        : "메시지 없음"
                    }
                  </p>
                  <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                      ${
                        room.lastMessage
                          ? new Date(room.lastMessage.createdAt).toLocaleString(
                              "ko-KR"
                            )
                          : ""
                      }
                    </small>
                    ${
                      room.unreadCount > 0
                        ? `<span class="badge bg-danger">${room.unreadCount}</span>`
                        : ""
                    }
                  </div>
                </div>
                <div class="card-footer">
                  <button
                    class="btn btn-sm btn-primary w-100"
                    onclick="enterChatRoom('${room.id}', '${userId}', '${
                room.post?.title || ""
              }')"
                  >
                    채팅방 입장
                  </button>
                </div>
              </div>
            </div>
          `
            )
            .join("");

          roomsList.innerHTML = html;
          if (roomsSection) roomsSection.style.display = "block";
        } catch (error) {
          console.error("Error loading chat rooms:", error);
        }
      }

      function enterChatRoom(chatRoomId, userId, postTitle) {
        document.getElementById("chat-room-id").value = chatRoomId;
        document.getElementById("user-id").value = userId;
        document.getElementById("chat-room-title").textContent =
          postTitle || "채팅방";
        document.getElementById("join-room-btn").click();
      }

      // URL에서 userId 가져오기 (위에서 이미 파싱한 urlUserId 재사용)
      if (urlUserId) {
        loadChatRooms(urlUserId);
        document.getElementById("user-id").value = urlUserId;
      }

      // 로컬 스토리지에서 사용자 정보 가져오기 (헤더 UI + 채팅방 목록에 반영)
      const storedUser = localStorage.getItem("currentUser");
      if (storedUser) {
        try {
          const user = JSON.parse(storedUser);

          // 1) 채팅방 목록 자동 로드
          if (user.id && !urlUserId) {
            loadChatRooms(user.id);
            document.getElementById("user-id").value = user.id;
          }

          // 2) 헤더 로그인/회원가입 버튼 숨기고, 현재 사용자 표시
          const loginBtnParent =
            document.getElementById("login-modal-btn")?.parentElement;
          const registerBtnParent =
            document.getElementById("register-modal-btn")?.parentElement;
          const currentUserDisplay = document.getElementById(
            "current-user-display"
          );
          const userNicknameDisplay = document.getElementById(
            "user-nickname-display"
          );

          if (loginBtnParent) loginBtnParent.classList.add("d-none");
          if (registerBtnParent) registerBtnParent.classList.add("d-none");
          if (currentUserDisplay) currentUserDisplay.classList.remove("d-none");
          if (userNicknameDisplay && user.nickname) {
            userNicknameDisplay.textContent = user.nickname;
          }
        } catch (e) {
          console.error("Error parsing user from storage:", e);
        }
      }

      // 로그아웃 버튼 동작 (홈과 동일하게 localStorage 정리 + 리다이렉트)
      const logoutBtn = document.getElementById("logout-btn");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", () => {
          // 저장된 사용자 정보 제거
          localStorage.removeItem("currentUser");

          // 채팅방 연결 정리
          if (socket && currentChatRoomId && currentUserId) {
            socket.emit("leave_chat_room", {
              chatRoomId: currentChatRoomId,
              userId: currentUserId,
            });
            socket.disconnect();
          }

          // 홈으로 이동해서 공통 UI 초기화 로직 사용
          window.location.href = "/";
        });
      }
    </script>
  </body>
</html>
