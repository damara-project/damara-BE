<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì‹¤ì‹œê°„ ì±„íŒ…</title>
    <link rel="stylesheet" type="text/css" href="/stylesheets/main.css" />

    <!-- Socket.io -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>

    <style>
      .chat-container {
        max-width: 1200px;
        margin: 0 auto;
        height: calc(100vh - 200px);
        display: flex;
        flex-direction: column;
      }

      .chat-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem;
        border-radius: 10px 10px 0 0;
      }

      .chat-messages {
        flex: 1;
        overflow-y: auto;
        background: white;
        padding: 1rem;
        border-left: 1px solid #dee2e6;
        border-right: 1px solid #dee2e6;
      }

      .message-item {
        margin-bottom: 1rem;
        padding: 0.75rem;
        border-radius: 10px;
        animation: fadeIn 0.3s ease-in;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .message-item.own-message {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        margin-left: auto;
        max-width: 70%;
        text-align: right;
      }

      .message-item.other-message {
        background: #f8f9fa;
        color: #212529;
        margin-right: auto;
        max-width: 70%;
      }

      .message-sender {
        font-weight: bold;
        font-size: 0.9rem;
        margin-bottom: 0.25rem;
      }

      .message-content {
        word-wrap: break-word;
      }

      .message-time {
        font-size: 0.75rem;
        opacity: 0.7;
        margin-top: 0.25rem;
      }

      .chat-input-area {
        background: white;
        padding: 1rem;
        border: 1px solid #dee2e6;
        border-radius: 0 0 10px 10px;
      }

      .connection-status {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 0.5rem;
      }

      .connection-status.connected {
        background-color: #28a745;
      }

      .connection-status.disconnected {
        background-color: #dc3545;
      }

      .system-message {
        text-align: center;
        color: #6c757d;
        font-style: italic;
        padding: 0.5rem;
        font-size: 0.9rem;
      }

      .chat-room-selector {
        background: white;
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 1rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
    </style>
  </head>

  <body>
    <!-- í—¤ë” -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm mb-4">
      <div class="container">
        <a class="navbar-brand fw-bold" href="/">
          <span style="font-size: 1.8rem">ğŸ’¬</span> ì‹¤ì‹œê°„ ì±„íŒ…
        </a>
        <div class="navbar-nav ms-auto">
          <a class="btn btn-outline-secondary btn-sm me-2" href="/">
            í™ˆìœ¼ë¡œ
          </a>
          <span class="align-middle me-2">
            <span class="connection-status disconnected" id="connection-status"></span>
            <span id="connection-text">ì—°ê²° ì¤‘...</span>
          </span>
        </div>
      </div>
    </nav>

    <div class="container">
      <!-- ì±„íŒ…ë°© ì„ íƒ ì˜ì—­ -->
      <div class="chat-room-selector">
        <h5 class="mb-3">ì±„íŒ…ë°© ì„¤ì •</h5>
        <div class="row g-3">
          <div class="col-md-4">
            <label for="chat-room-id" class="form-label">ì±„íŒ…ë°© ID</label>
            <input
              type="text"
              class="form-control"
              id="chat-room-id"
              placeholder="ì±„íŒ…ë°© UUID ì…ë ¥"
            />
          </div>
          <div class="col-md-4">
            <label for="user-id" class="form-label">ì‚¬ìš©ì ID</label>
            <input
              type="text"
              class="form-control"
              id="user-id"
              placeholder="ì‚¬ìš©ì UUID ì…ë ¥"
            />
          </div>
          <div class="col-md-4 d-flex align-items-end">
            <button class="btn btn-primary w-100" id="join-room-btn">
              ì±„íŒ…ë°© ì…ì¥
            </button>
          </div>
        </div>
        <div class="mt-3">
          <small class="text-muted">
            ğŸ’¡ íŒ: ë¨¼ì € Postë¥¼ ìƒì„±í•œ í›„, í•´ë‹¹ Postì˜ IDë¡œ ì±„íŒ…ë°©ì„ ìƒì„±í•˜ì„¸ìš”.
            <br />
            API: POST /api/chat/rooms (body: { chatRoom: { postId } })
          </small>
        </div>
      </div>

      <!-- ì±„íŒ… ì»¨í…Œì´ë„ˆ -->
      <div class="chat-container shadow-lg" id="chat-container" style="display: none">
        <div class="chat-header">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h5 class="mb-0" id="chat-room-title">ì±„íŒ…ë°©</h5>
              <small id="chat-room-id-display"></small>
            </div>
            <button class="btn btn-light btn-sm" id="leave-room-btn">
              ë‚˜ê°€ê¸°
            </button>
          </div>
        </div>

        <div class="chat-messages" id="chat-messages">
          <!-- ë©”ì‹œì§€ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>

        <div class="chat-input-area">
          <div class="input-group">
            <input
              type="text"
              class="form-control"
              id="message-input"
              placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
              disabled
            />
            <button
              class="btn btn-primary"
              type="button"
              id="send-message-btn"
              disabled
            >
              ì „ì†¡
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ì „ì—­ ë³€ìˆ˜
      let socket = null;
      let currentChatRoomId = null;
      let currentUserId = null;

      // DOM ìš”ì†Œ
      const chatRoomIdInput = document.getElementById("chat-room-id");
      const userIdInput = document.getElementById("user-id");
      const joinRoomBtn = document.getElementById("join-room-btn");
      const leaveRoomBtn = document.getElementById("leave-room-btn");
      const chatContainer = document.getElementById("chat-container");
      const chatMessages = document.getElementById("chat-messages");
      const messageInput = document.getElementById("message-input");
      const sendMessageBtn = document.getElementById("send-message-btn");
      const connectionStatus = document.getElementById("connection-status");
      const connectionText = document.getElementById("connection-text");
      const chatRoomTitle = document.getElementById("chat-room-title");
      const chatRoomIdDisplay = document.getElementById("chat-room-id-display");

      // Socket.io ì—°ê²°
      function connectSocket() {
        socket = io("http://localhost:3000", {
          transports: ["websocket", "polling"],
        });

        socket.on("connect", () => {
          console.log("âœ“ ì„œë²„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤:", socket.id);
          updateConnectionStatus(true);
        });

        socket.on("disconnect", () => {
          console.log("âœ— ì„œë²„ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤");
          updateConnectionStatus(false);
        });

        socket.on("connect_error", (error) => {
          console.error("âœ— ì—°ê²° ì˜¤ë¥˜:", error);
          updateConnectionStatus(false);
          showSystemMessage("ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.");
        });

        // ë©”ì‹œì§€ ìˆ˜ì‹ 
        socket.on("receive_message", (message) => {
          console.log("ë©”ì‹œì§€ ìˆ˜ì‹ :", message);
          displayMessage(message);
        });

        // ì‚¬ìš©ì ì…ì¥ ì•Œë¦¼
        socket.on("user_joined", (data) => {
          console.log("ì‚¬ìš©ì ì…ì¥:", data);
          showSystemMessage(`ì‚¬ìš©ìê°€ ì±„íŒ…ë°©ì— ì…ì¥í–ˆìŠµë‹ˆë‹¤.`);
        });

        // ì‚¬ìš©ì í‡´ì¥ ì•Œë¦¼
        socket.on("user_left", (data) => {
          console.log("ì‚¬ìš©ì í‡´ì¥:", data);
          showSystemMessage(`ì‚¬ìš©ìê°€ ì±„íŒ…ë°©ì„ ë‚˜ê°”ìŠµë‹ˆë‹¤.`);
        });

        // ë©”ì‹œì§€ ì½ìŒ ì²˜ë¦¬ ì•Œë¦¼
        socket.on("message_read", (data) => {
          console.log("ë©”ì‹œì§€ ì½ìŒ:", data);
        });

        // ì—ëŸ¬ ì²˜ë¦¬
        socket.on("error", (error) => {
          console.error("ì—ëŸ¬:", error);
          showSystemMessage(`ì˜¤ë¥˜: ${error.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."}`);
        });
      }

      // ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
      function updateConnectionStatus(connected) {
        if (connected) {
          connectionStatus.classList.remove("disconnected");
          connectionStatus.classList.add("connected");
          connectionText.textContent = "ì—°ê²°ë¨";
        } else {
          connectionStatus.classList.remove("connected");
          connectionStatus.classList.add("disconnected");
          connectionText.textContent = "ì—°ê²° ëŠê¹€";
        }
      }

      // ì±„íŒ…ë°© ì…ì¥
      joinRoomBtn.addEventListener("click", () => {
        const chatRoomId = chatRoomIdInput.value.trim();
        const userId = userIdInput.value.trim();

        if (!chatRoomId || !userId) {
          alert("ì±„íŒ…ë°© IDì™€ ì‚¬ìš©ì IDë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        if (!socket || !socket.connected) {
          alert("ì„œë²„ì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
          return;
        }

        // ì±„íŒ…ë°© ì…ì¥
        socket.emit("join_chat_room", {
          chatRoomId: chatRoomId,
          userId: userId,
        });

        currentChatRoomId = chatRoomId;
        currentUserId = userId;

        // UI ì—…ë°ì´íŠ¸
        chatContainer.style.display = "flex";
        chatRoomTitle.textContent = "ì±„íŒ…ë°©";
        chatRoomIdDisplay.textContent = `ID: ${chatRoomId}`;
        messageInput.disabled = false;
        sendMessageBtn.disabled = false;
        chatRoomIdInput.disabled = true;
        userIdInput.disabled = true;
        joinRoomBtn.disabled = true;

        // ë©”ì‹œì§€ íˆìŠ¤í† ë¦¬ ë¡œë“œ
        loadMessageHistory(chatRoomId);
      });

      // ì±„íŒ…ë°© ë‚˜ê°€ê¸°
      leaveRoomBtn.addEventListener("click", () => {
        if (socket && currentChatRoomId && currentUserId) {
          socket.emit("leave_chat_room", {
            chatRoomId: currentChatRoomId,
            userId: currentUserId,
          });
        }

        // UI ì´ˆê¸°í™”
        chatContainer.style.display = "none";
        chatMessages.innerHTML = "";
        messageInput.value = "";
        messageInput.disabled = true;
        sendMessageBtn.disabled = true;
        chatRoomIdInput.disabled = false;
        userIdInput.disabled = false;
        joinRoomBtn.disabled = false;

        currentChatRoomId = null;
        currentUserId = null;
      });

      // ë©”ì‹œì§€ ì „ì†¡
      function sendMessage() {
        const content = messageInput.value.trim();
        if (!content || !socket || !currentChatRoomId || !currentUserId) {
          return;
        }

        socket.emit("send_message", {
          chatRoomId: currentChatRoomId,
          senderId: currentUserId,
          content: content,
          messageType: "text",
        });

        messageInput.value = "";
      }

      sendMessageBtn.addEventListener("click", sendMessage);
      messageInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          sendMessage();
        }
      });

      // ë©”ì‹œì§€ í‘œì‹œ
      function displayMessage(message) {
        const messageDiv = document.createElement("div");
        messageDiv.className = `message-item ${
          message.senderId === currentUserId ? "own-message" : "other-message"
        }`;

        const senderName = message.sender?.nickname || "ì•Œ ìˆ˜ ì—†ìŒ";
        const messageTime = new Date(message.createdAt).toLocaleTimeString("ko-KR", {
          hour: "2-digit",
          minute: "2-digit",
        });

        messageDiv.innerHTML = `
          <div class="message-sender">${senderName}</div>
          <div class="message-content">${escapeHtml(message.content)}</div>
          <div class="message-time">${messageTime}</div>
        `;

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // ì‹œìŠ¤í…œ ë©”ì‹œì§€ í‘œì‹œ
      function showSystemMessage(text) {
        const systemDiv = document.createElement("div");
        systemDiv.className = "system-message";
        systemDiv.textContent = text;
        chatMessages.appendChild(systemDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // ë©”ì‹œì§€ íˆìŠ¤í† ë¦¬ ë¡œë“œ
      async function loadMessageHistory(chatRoomId) {
        try {
          const response = await fetch(
            `http://localhost:3000/api/chat/rooms/${chatRoomId}/messages?limit=50&offset=0`
          );
          if (response.ok) {
            const messages = await response.json();
            chatMessages.innerHTML = "";
            messages.forEach((message) => {
              displayMessage(message);
            });
          }
        } catch (error) {
          console.error("ë©”ì‹œì§€ íˆìŠ¤í† ë¦¬ ë¡œë“œ ì‹¤íŒ¨:", error);
        }
      }

      // HTML ì´ìŠ¤ì¼€ì´í”„
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ Socket.io ì—°ê²°
      connectSocket();

      // í˜ì´ì§€ ì¢…ë£Œ ì‹œ ì—°ê²° í•´ì œ
      window.addEventListener("beforeunload", () => {
        if (socket && currentChatRoomId && currentUserId) {
          socket.emit("leave_chat_room", {
            chatRoomId: currentChatRoomId,
            userId: currentUserId,
          });
          socket.disconnect();
        }
      });
    </script>
  </body>
</html>

